# Telegram 频道备份系统 - 功能设计文档

## 项目背景

解决 Telegram 频道被封禁后无法查看历史消息的问题，通过将源频道消息镜像到备份频道，并提供 Web 界面进行管理和浏览。

## 核心需求

| 需求项 | 选择 |
|--------|------|
| 内容类型 | 全部内容（文字、图片、视频、文件、音频） |
| 访问方式 | Web 界面 + Telegram 备份频道 |
| 频道支持 | 多个源频道 → 多个镜像频道 |
| 备份方式 | 自动实时同步到镜像频道 |
| 用户模式 | 个人使用（无需多用户系统） |
| 搜索功能 | 全文搜索 + 按日期筛选 + 按类型筛选 |
| 历史消息 | 全量历史镜像 + 新消息持续同步 |

## 关键约束与取舍（建议在实现前确认）

- **客户端协议选择**：需要使用 Telegram **用户账号（MTProto）** 获取历史消息；Bot API 无法拉取频道历史消息。
- **受保护内容**：源频道可能开启“**保护内容/禁止转发**”，导致转发/复制失败；建议在频道状态中明确展示，并支持跳过/降级策略（例如仅记录索引与错误原因）。
- **限流与上限**：需要处理 `FLOOD_WAIT` 等限流异常，以及 Telegram 文件大小/发送频率上限；建议设计全局与按频道的限速、重试与暂停机制。
- **Web 访问控制**：即便单人使用，也建议提供最小访问控制（仅本机访问/密码/反向代理 Basic Auth），避免凭证与数据暴露。

---

## 功能模块设计

### 1. 频道管理模块

#### 1.1 源频道管理
- 添加源频道（支持频道链接或用户名）
- 删除/取消订阅源频道
- 查看已订阅源频道列表
- 显示频道基本信息（名称、头像、描述、成员数）

#### 1.2 镜像频道管理
- **自动创建模式**：系统自动创建私有频道作为镜像目标
- **指定频道模式**：用户指定已有的频道作为镜像目标
- 每个源频道对应一个镜像频道
- 显示镜像频道链接，可直接跳转到 Telegram 查看

#### 1.3 频道状态
- 显示同步状态（同步中/已完成/错误）
- 显示最后同步时间
- 显示已镜像消息数量
- 显示频道是否受保护（禁止转发/复制）
- 支持启用/暂停该频道同步（可选）
- 支持设置同步优先级（可选）
- 源频道与镜像频道的映射关系

---

### 2. 消息镜像模块

#### 2.1 历史消息镜像
- 首次添加源频道时自动镜像全部历史消息
- 支持断点续传（中断后可继续）
- 通过同步任务表记录进度与游标（见 `sync_tasks`）
- 支持暂停/恢复/取消历史镜像任务
- 显示镜像进度（已完成/总数）
- 按时间顺序镜像，保持消息顺序一致

#### 2.2 实时同步
- 监听源频道新消息
- 自动转发/复制到镜像频道
- 实时同步作为后台常驻任务运行（可记录为 `sync_tasks` 的 `realtime` 类型）
- 后台常驻服务，持续运行

#### 2.3 镜像方式
- **转发模式**：直接转发消息（保留"转发自"标记）
- **复制模式**：复制消息内容发送（无转发标记，更干净）
- 可在设置中选择镜像方式

#### 2.4 内容处理
- 文字消息：完整复制
- 图片：原图转发/复制
- 视频：完整转发/复制
- 文件：完整转发/复制
- 音频：完整转发/复制
- 可配置文件大小限制（跳过超大文件）

#### 2.5 重要边界场景（建议补充）
- **媒体组/相册**：同一组消息需尽量保持为一组发送/复制（避免拆散导致体验差）。
- **编辑与撤回**：
  - 编辑：备份快照默认**不同步**编辑到镜像频道（镜像消息一旦发送不再修改）；可选仅记录“发生过编辑”的标记/历史到数据库。
  - 撤回：备份场景通常**不建议**同步撤回到镜像频道（以免“备份也被删”）；可选仅记录 `is_deleted/deleted_at` 标记到数据库。
- **置顶/投票/服务消息**：是否需要镜像这类消息建议提前定义（至少明确“不支持/跳过”的规则）。

#### 2.6 失败、重试与跳过（建议）
- 为每条消息记录镜像状态（pending/success/failed/skipped）与错误信息
- 失败消息自动重试（受 `max_retry_count`、`retry_interval` 等设置控制）
- 不可镜像或超过重试上限的消息标记为 skipped，并记录 `skip_reason`

---

### 3. 存储模块

#### 3.1 元数据存储
数据库建议仅存储**映射关系、状态与可检索的元数据**；媒体内容仍以镜像频道为准。

> 说明：若 Web 需要“全文搜索”，仅存 `text_preview` 会导致搜索不完整；推荐存储**完整文本/Caption**（不存媒体），并为文本建立索引。

#### 3.2 数据结构

**源频道表 (source_channels)**
| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| telegram_id | Telegram 频道 ID |
| name | 频道名称 |
| username | 频道用户名 |
| avatar_url | 头像 URL |
| description | 频道描述 |
| subscribed_at | 订阅时间 |
| last_sync_at | 最后同步时间 |
| sync_status | 同步状态 (pending/syncing/completed/error) |
| last_message_id | 已同步的最后一条消息 ID |
| is_protected | 是否为受保护频道（禁止转发） |
| member_count | 频道成员数量 |
| total_messages | 频道消息总数（用于计算镜像进度，可能为估算值） |
| mirror_mode | 该频道的镜像方式（forward/copy），可覆盖全局设置 |
| is_active | 是否启用同步（布尔值，允许暂停某个频道） |
| priority | 同步优先级（多频道时决定处理顺序） |

**镜像频道表 (mirror_channels)**
| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| source_channel_id | 关联的源频道 ID |
| telegram_id | 镜像频道的 Telegram ID |
| name | 镜像频道名称 |
| username | 镜像频道用户名（如有） |
| invite_link | 镜像频道邀请链接 |
| is_auto_created | 是否系统自动创建 |
| created_at | 创建时间 |

**消息映射表 (message_mappings)**
| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| source_channel_id | 源频道 ID |
| source_message_id | 源消息 ID |
| mirror_channel_id | 镜像频道 ID |
| mirror_message_id | 镜像消息 ID |
| message_type | 消息类型 |
| media_group_id | 媒体组 ID（用于关联同一相册/媒体组的多条消息） |
| status | 镜像状态（pending/success/failed/skipped） |
| skip_reason | 跳过原因（如：protected_content/file_too_large/unsupported_type） |
| error_message | 失败时的错误信息 |
| retry_count | 已重试次数 |
| has_media | 是否包含媒体文件（布尔值） |
| file_size | 媒体文件大小（字节，用于筛选和统计） |
| text | 文本内容/Caption（可选，用于搜索；不含媒体） |
| text_preview | 文本预览（便于列表展示，可由 `text` 派生） |
| sent_at | 原消息发送时间 |
| mirrored_at | 镜像时间 |
| is_deleted | 源消息是否已被撤回（布尔值） |
| deleted_at | 源消息撤回时间 |
| edit_count | 源消息被编辑次数 |
| last_edited_at | 源消息最后编辑时间 |

##### message_mappings 状态说明

| status 值 | 含义 |
|-----------|------|
| pending | 待处理（已记录，尚未镜像） |
| success | 镜像成功 |
| failed | 镜像失败（可重试） |
| skipped | 已跳过（不可镜像，记录原因） |

##### message_mappings 跳过原因说明

| skip_reason 值 | 含义 |
|----------------|------|
| protected_content | 源频道禁止转发/复制 |
| file_too_large | 文件超过大小限制 |
| unsupported_type | 不支持的消息类型（如投票、服务消息） |
| rate_limited_skip | 因限流多次重试失败后跳过 |

**同步任务表 (sync_tasks)**

用于管理历史镜像任务的状态和进度，使任务可暂停、可恢复、可追踪。

| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| source_channel_id | 源频道 ID |
| task_type | 任务类型（见下表） |
| status | 任务状态（见下表） |
| progress_current | 当前进度（已处理消息数） |
| progress_total | 总数（频道消息总数，可为估算值） |
| last_processed_id | 最后处理的消息 ID（用于断点续传） |
| started_at | 任务开始时间 |
| completed_at | 任务完成时间 |
| paused_at | 任务暂停时间 |
| last_error | 最近一次错误信息 |
| created_at | 任务创建时间 |

##### 任务类型说明

| task_type 值 | 含义 |
|--------------|------|
| history_full | 全量历史镜像（首次添加频道时） |
| history_partial | 部分历史镜像（指定时间范围） |
| realtime | 实时监听同步 |

##### 任务状态说明

| status 值 | 含义 |
|-----------|------|
| pending | 待开始 |
| running | 运行中 |
| paused | 已暂停（用户手动暂停或系统限流暂停） |
| completed | 已完成 |
| failed | 失败（需人工干预） |

**消息编辑历史表 (message_edits)（可选）**

如果需要追踪源消息的编辑历史（用于 Web 展示/审计），建议增加此表；**不要求同步编辑到镜像频道**。

| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| message_mapping_id | 关联的消息映射 ID |
| version | 版本号（1, 2, 3...） |
| previous_text | 编辑前的文本 |
| new_text | 编辑后的文本 |
| edited_at | 编辑时间（源消息的编辑时间） |
| created_at | 记录创建时间 |

#### 3.3 索引与约束（建议）
- `source_channels.telegram_id` 唯一（避免重复订阅同一频道）
- `mirror_channels.source_channel_id` 唯一（保证 1:1 映射）
- `message_mappings (source_channel_id, source_message_id)` 唯一（保证幂等，支持重跑）
- 常用查询索引：
  - `message_mappings (source_channel_id, sent_at DESC)`
  - `message_mappings (message_type, sent_at DESC)`
  - `message_mappings (status, source_channel_id)`（查询失败/待重试消息）
  - `message_mappings (media_group_id)`（查询同一媒体组）
  - `message_mappings (is_deleted)`（筛选已撤回消息）
  - `message_mappings (mirrored_at DESC)`
  - `text` 的全文/关键词索引（按所选数据库能力实现）
- 同步任务索引：
  - `sync_tasks (source_channel_id, status)`
  - `sync_tasks (status, created_at)`
- 编辑历史索引（可选）：
  - `message_edits (message_mapping_id, version)`

##### Web 搜索索引（Supabase/Postgres，中文优先）

中文搜索更推荐 `pg_trgm` + `ILIKE`/相似度检索（注意索引体积），示意：

```sql
create extension if not exists pg_trgm;

create index if not exists message_mappings_text_trgm_idx
  on message_mappings
  using gin (text gin_trgm_ops);
```

#### 3.4 运行状态与日志（可选，但强烈推荐）
为便于排障与可视化进度，建议增加“同步事件/错误日志”存储（DB 表或本地日志文件均可），例如：

**同步事件表 (sync_events)**
| 字段 | 说明 |
|------|------|
| id | 唯一标识 |
| source_channel_id | 源频道 ID |
| level | 级别 (info/warn/error) |
| message | 事件内容 |
| created_at | 时间 |

---

### 4. Web 界面模块

#### 4.1 仪表盘/首页
- 总订阅源频道数
- 总镜像消息数量
- 同步状态概览
- 最近同步活动日志

#### 4.2 频道管理页面
- 添加新源频道入口
- 源频道列表（卡片式展示）
- 每个频道卡片显示：
  - 源频道头像和名称
  - 镜像频道链接（可点击跳转）
  - 消息数量
  - 同步状态（同步中显示进度条）
  - 最后同步时间
- 镜像频道设置（选择转发/复制模式）
- 删除频道操作（需确认）

#### 4.3 消息浏览页面
- 消息列表展示（基于消息映射表）
- 消息按时间倒序排列
- 支持无限滚动加载
- 每条消息显示：
  - 发送时间
  - 文本预览
  - 消息类型图标
  - "在 Telegram 中查看" 链接
- 点击消息跳转到镜像频道对应位置

#### 4.4 搜索与筛选
- 全局搜索框（搜索 `text`/Caption，列表展示 `text_preview`）
- 频道筛选下拉框
- 日期范围选择器
- 消息类型筛选：
  - 全部
  - 文字消息
  - 图片
  - 视频
  - 文件
  - 音频
- 中文搜索实现建议：Supabase/Postgres 侧使用 `pg_trgm` + `ILIKE`/相似度检索（关键词建议 ≥ 3，注意索引体积与免费额度）
- 搜索结果高亮显示关键词

#### 4.5 任务管理页面（新增）
- 显示所有同步任务列表
- 每个任务显示：
  - 关联频道名称
  - 任务类型
  - 当前状态
  - 进度条（已完成/总数）
  - 开始时间、预计完成时间
  - 最近错误（如有）
- 操作按钮：暂停、恢复、取消、重试

#### 4.6 频道详情页面增强（新增）
- 显示频道的受保护状态
- 显示该频道的镜像模式（转发/复制）
- 单独控制该频道的同步开关
- 显示失败/跳过的消息统计
- 查看失败消息列表及原因

#### 4.7 消息浏览页面增强（新增）
- 消息状态标记（成功/失败/跳过）
- 筛选条件增加：
  - 按状态筛选（全部/成功/失败/跳过）
  - 按是否有媒体筛选
  - 按文件大小范围筛选
- 显示消息是否被编辑过（编辑标记）
- 显示消息是否已被源频道撤回（撤回标记）

---

### 5. 系统设置模块

#### 5.1 Telegram 账号配置
- API ID 输入
- API Hash 输入
- 手机号登录
- 登录状态显示
- 退出登录

#### 5.2 镜像设置
- 默认镜像方式（转发/复制）
- 并发镜像数量
- 镜像间隔（避免触发限流）

#### 5.3 镜像频道设置
- 自动创建频道的命名规则（如：[备份] 原频道名）
- 自动创建频道的默认设置（私有/公开）

#### 5.4 同步行为设置（重试/跳过）

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| max_retry_count | 失败消息最大重试次数 | 3 |
| retry_interval | 重试间隔（秒） | 60 |
| skip_after_max_retry | 达到最大重试次数后是否跳过 | 是 |

#### 5.5 编辑与撤回设置

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| sync_message_edits | 记录源消息编辑信息到数据库（不修改镜像频道消息） | 否 |
| keep_edit_history | 保留编辑历史记录（仅 DB，可选） | 是 |
| sync_message_deletions | 记录源消息撤回状态到数据库（不删除镜像频道消息） | 否 |

#### 5.6 媒体处理设置

| 设置项 | 说明 | 默认值 |
|--------|------|--------|
| mirror_videos | 是否镜像视频 | 是 |
| max_file_size_mb | 最大文件大小（MB），超过则跳过 | 100 |
| skip_protected_content | 遇到受保护内容时跳过（否则报错） | 是 |
| group_media_messages | 保持媒体组消息一起发送 | 是 |

---

## 系统架构

### 服务角色划分

建议将系统拆分为两个服务角色：

| 服务 | 职责 | 运行方式 |
|------|------|----------|
| **API 服务** | 处理 Web 请求（频道管理、消息查询、搜索、设置） | 按需响应 |
| **镜像服务** | 监听源频道新消息、执行历史镜像任务、处理限流与重试 | 后台常驻 |

两者共享同一个数据库，通过数据库进行状态同步与任务协调。

**API 服务**
- 接收用户请求（添加频道、查询消息、修改设置等）
- 创建同步任务（写入 `sync_tasks`，由镜像服务执行）
- 查询同步状态、进度与错误
- 不直接与 Telegram 交互（或仅做轻量查询）

**镜像服务**
- 启动时加载所有活跃的同步任务
- 监听源频道的新消息事件
- 执行历史消息镜像（读取待执行任务，逐条处理）
- 处理限流（暂停、等待、重试）
- 更新任务状态和消息映射记录

```
┌─────────────────────────────────────────────────────────┐
│                      Web 前端界面                        │
│         (频道管理 / 消息浏览 / 搜索 / 设置)               │
└─────────────────────────────────────────────────────────┘
                            │
                            ▼
┌─────────────────────────────────────────────────────────┐
│                      后端 API 服务                       │
│        (频道管理 / 消息查询 / 搜索 / 状态监控)            │
└─────────────────────────────────────────────────────────┘
                            │
            ┌───────────────┴───────────────┐
            ▼                               ▼
      ┌──────────┐                 ┌──────────────────┐
      │  数据库   │                 │  Telegram 镜像    │
      │ (映射/    │                 │      服务         │
      │  状态)    │                 │  (MTProto API)   │
      └──────────┘                 └──────────────────┘
                                            │
                          ┌─────────────────┼─────────────────┐
                          ▼                 ▼                 ▼
                    ┌──────────┐     ┌──────────┐     ┌──────────┐
                    │ 源频道 A  │     │ 源频道 B  │     │ 源频道 C  │
                    └──────────┘     └──────────┘     └──────────┘
                          │                 │                 │
                          ▼                 ▼                 ▼
                    ┌──────────┐     ┌──────────┐     ┌──────────┐
                    │ 镜像频道 A │     │ 镜像频道 B │     │ 镜像频道 C │
                    └──────────┘     └──────────┘     └──────────┘
```

---

## 用户使用流程

```
1. 初始配置
   └── 配置 Telegram API 凭证 → 手机号登录

2. 添加源频道
   └── 输入频道链接/用户名 → 选择镜像方式（自动创建/指定频道）

3. 等待镜像
   └── 历史消息镜像（显示进度） → 完成后持续监听新消息

4. 浏览查看
   ├── 方式1：直接在 Telegram 打开镜像频道查看
   └── 方式2：通过 Web 界面搜索筛选，跳转到具体消息

5. 持续运行
   └── 系统后台运行 → 自动镜像新消息到备份频道
```

---

## 镜像模式对比

| 特性 | 转发模式 | 复制模式 |
|------|----------|----------|
| 来源标记 | 显示"转发自 XXX" | 无来源标记 |
| 实现复杂度 | 简单 | 较复杂 |
| 原始信息保留 | 保留转发信息 | 仅保留内容 |
| 适用场景 | 需要追溯来源 | 干净的备份副本 |

---

## 后续可扩展功能（暂不实现）

- [ ] 消息导出功能（从镜像频道导出）
- [ ] 多用户支持和权限管理
- [ ] 定时备份报告（邮件通知）
- [ ] 频道分组/分类管理
- [ ] 源频道状态监控（检测是否被封）
- [ ] 镜像频道自动备份（二次备份）
